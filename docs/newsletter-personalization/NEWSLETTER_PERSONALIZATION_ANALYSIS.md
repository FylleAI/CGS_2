# üìß Newsletter Personalizzata Settimanale - Analisi Completa

**Project**: Personalized Weekly Newsletter for User Retention  
**Version**: 1.0  
**Date**: 2025-10-25  
**Status**: Planning Phase ‚úÖ

---

## üéØ EXECUTIVE SUMMARY

### Obiettivo Strategico

Creare un sistema di **Newsletter Personalizzata Settimanale** che massimizzi la **retention** degli utenti attraverso contenuti di alto valore tailor-made basati su:
- Profilo aziendale dell'utente
- Settore di business
- Competitor e loro attivit√†
- Trend di mercato rilevanti

### Valore di Business

- ‚úÖ **Retention**: Touchpoint settimanale automatico con valore concreto
- ‚úÖ **Engagement**: Contenuti personalizzati aumentano aperture e click
- ‚úÖ **Upsell**: Opportunit√† di promuovere feature premium
- ‚úÖ **Brand Authority**: Posizionamento come fonte di intelligence di mercato
- ‚úÖ **Data Collection**: Feedback loop per migliorare personalizzazione

---

## üìä STATO ATTUALE - COSA ABBIAMO

### 1. ‚úÖ Newsletter Workflow Esistente (Siebert)

**Componenti Disponibili**:

| Componente | File | Riutilizzabile | Note |
|------------|------|----------------|------|
| **Workflow Template** | `siebert_premium_newsletter.json` | ‚úÖ S√¨ | 3-task workflow (RAG + Research + Assembly) |
| **HTML Workflow** | `siebert_newsletter_html.json` | ‚úÖ S√¨ | Include HTML email builder |
| **Premium Handler** | `premium_newsletter_handler.py` | ‚úÖ S√¨ | Gestione brand guidelines + sources |
| **Siebert Handler** | `siebert_premium_newsletter_handler.py` | ‚ö†Ô∏è Parziale | Troppo specifico per Siebert |
| **HTML Handler** | `siebert_newsletter_html_handler.py` | ‚úÖ S√¨ | HTML design system |
| **Newsletter Config** | `NewsletterConfig` in `content_types.py` | ‚úÖ S√¨ | Pydantic model per config |

**Workflow Structure** (Siebert Premium):
```
Task 1: RAG Specialist ‚Üí Brand Context & Template Setup
Task 2: Research Specialist ‚Üí Perplexity Multi-Source Research
Task 3: Copywriter ‚Üí Newsletter Assembly (8 sections)
Task 4: Compliance Specialist ‚Üí FINRA/SEC Review (optional)
Task 5: HTML Email Builder ‚Üí HTML Container (optional)
```

**Features Esistenti**:
- ‚úÖ Multi-source research con Perplexity
- ‚úÖ RAG integration per brand context
- ‚úÖ Customizable word count (800-1500)
- ‚úÖ Customizable sections (3-8)
- ‚úÖ HTML email output
- ‚úÖ Brand voice integration
- ‚úÖ Cost tracking e metrics

---

### 2. ‚úÖ Onboarding System

**Componenti Disponibili**:

| Componente | File | Riutilizzabile | Note |
|------------|------|----------------|------|
| **Company Research** | `ResearchCompanyUseCase` | ‚úÖ S√¨ | Perplexity research con RAG cache |
| **Company Snapshot** | `CompanySnapshot` model | ‚úÖ S√¨ | Rich company profile |
| **User Profiling** | `OnboardingSession` | ‚ö†Ô∏è Parziale | Manca subscription preferences |
| **Email Delivery** | `BrevoAdapter` | ‚úÖ S√¨ | Transactional email ready |
| **Persistence** | `SupabaseSessionRepository` | ‚úÖ S√¨ | Session tracking |

**Company Snapshot Fields** (Riutilizzabili):
```python
CompanySnapshot:
  - company: CompanyInfo
    - name, industry, description
    - key_offerings, differentiators
  - audience: AudienceInfo
    - primary, secondary, pain_points
  - voice: VoiceInfo
    - tone, style_guidelines
  - insights: InsightsInfo
    - positioning, key_messages
    - recent_news, competitors  ‚Üê IMPORTANTE!
```

**Onboarding Flow**:
```
1. Research Company (Perplexity)
2. Synthesize Snapshot (Gemini)
3. Generate Clarifying Questions
4. Collect Answers
5. Execute Workflow
6. Deliver via Email (Brevo)
7. Persist to Supabase
```

---

### 3. ‚úÖ Research & Intelligence Tools

**Componenti Disponibili**:

| Tool | File | Capability | Cost |
|------|------|------------|------|
| **Perplexity** | `PerplexityResearchTool` | Web research, recent news | ~$0.005/call |
| **Serper** | `WebSearchTool` | Google search | ~$0.002/call |
| **RAG** | `RagTool` | Company knowledge base | Free |

**Perplexity Capabilities**:
- ‚úÖ Real-time web research
- ‚úÖ Multi-source aggregation
- ‚úÖ Timeframe filtering (last 7 days, yesterday, last month)
- ‚úÖ Domain filtering
- ‚úÖ Citation tracking

**Existing Research Patterns**:
```python
# From ResearchCompanyUseCase
research_result = await perplexity.research_with_retry(
    brand_name=session.brand_name,
    website=session.website,
    additional_context=additional_context,
)
```

---

### 4. ‚úÖ Email Delivery System

**Componenti Disponibili**:

| Componente | Capability | Status |
|------------|------------|--------|
| **Brevo Adapter** | Transactional email | ‚úÖ Production-ready |
| **HTML Templates** | Email formatting | ‚úÖ Available |
| **Template Support** | Brevo templates | ‚úÖ Configured |
| **Idempotency** | Session-based dedup | ‚úÖ Implemented |
| **Retry Logic** | Exponential backoff | ‚úÖ Implemented |

**Email Features**:
- ‚úÖ HTML + Plain text fallback
- ‚úÖ Custom headers (X-Session-Id, X-Content-Id)
- ‚úÖ Tags for categorization
- ‚úÖ Delivery tracking (message_id, timestamp)

---

### 5. ‚úÖ Database & Persistence

**Existing Tables** (Supabase):

| Table | Purpose | Reusable |
|-------|---------|----------|
| `onboarding_sessions` | Session tracking | ‚ö†Ô∏è Parziale |
| `company_contexts` | RAG cache for companies | ‚úÖ S√¨ |
| `clients` | Client profiles | ‚úÖ S√¨ |
| `documents` | Knowledge base | ‚úÖ S√¨ |
| `content_generations` | Generated content | ‚úÖ S√¨ |
| `workflow_runs` | Workflow tracking | ‚úÖ S√¨ |

**Existing Fields** (Riutilizzabili):
```sql
onboarding_sessions:
  - brand_name, website, user_email
  - snapshot (JSONB) ‚Üí CompanySnapshot
  - metadata (JSONB) ‚Üí Extensible

company_contexts:
  - company_name, website
  - company_snapshot (JSONB)
  - usage_count, last_used_at
```

---

### 6. ‚úÖ Adaptive Cards System

**Componenti Disponibili**:

| Componente | File | Capability |
|------------|------|------------|
| **Card Storage** | `context_cards` table | Store dynamic cards |
| **Card Types** | Multiple types | Persona, Product, Trend, etc. |
| **Performance Tracking** | `card_performance_events` | Track usage & engagement |
| **Relationships** | `card_relationships` | Link related cards |

**Integration Opportunity**:
- ‚úÖ Newsletter content ‚Üí Create/Update Adaptive Cards
- ‚úÖ Cards ‚Üí Inform newsletter personalization
- ‚úÖ Performance feedback ‚Üí Improve content

---

## ‚ùå COSA MANCA - GAP ANALYSIS

### 1. ‚ùå User Subscription Management

**Missing Components**:
- ‚ùå **Newsletter Subscriptions Table**: Track who is subscribed
- ‚ùå **Subscription Preferences**: Frequency, topics, format
- ‚ùå **Opt-in/Opt-out Flow**: GDPR-compliant subscription management
- ‚ùå **Unsubscribe Tokens**: Secure unsubscribe links
- ‚ùå **Subscription Status**: Active, paused, cancelled

**Required Schema**:
```sql
newsletter_subscriptions:
  - subscription_id (UUID)
  - tenant_id (UUID) -- Multi-tenant
  - user_id (UUID)
  - user_email (TEXT)
  - company_snapshot_id (UUID) -- Link to company profile
  - status (TEXT) -- active, paused, cancelled
  - frequency (TEXT) -- weekly, biweekly, monthly
  - preferred_day (TEXT) -- monday, tuesday, etc.
  - preferred_time (TIME) -- 09:00, 14:00, etc.
  - topics_of_interest (TEXT[]) -- competitors, trends, news
  - created_at, updated_at
  - last_sent_at
  - unsubscribe_token (TEXT)
```

---

### 2. ‚ùå Competitor Tracking System

**Missing Components**:
- ‚ùå **Competitor Database**: Store competitor profiles
- ‚ùå **Competitor Research**: Automated competitor discovery
- ‚ùå **Competitor Monitoring**: Track competitor activities
- ‚ùå **Competitor News**: Aggregate competitor news/updates
- ‚ùå **Competitive Intelligence**: Analyze competitor strategies

**Required Schema**:
```sql
competitors:
  - competitor_id (UUID)
  - tenant_id (UUID)
  - company_id (UUID) -- Our client
  - competitor_name (TEXT)
  - competitor_website (TEXT)
  - competitor_industry (TEXT)
  - relationship_type (TEXT) -- direct, indirect, emerging
  - monitoring_enabled (BOOLEAN)
  - last_researched_at (TIMESTAMPTZ)
  - snapshot (JSONB) -- CompanySnapshot-like structure
  - created_at, updated_at

competitor_activities:
  - activity_id (UUID)
  - competitor_id (UUID)
  - activity_type (TEXT) -- product_launch, funding, news, hiring
  - title (TEXT)
  - description (TEXT)
  - source_url (TEXT)
  - published_at (TIMESTAMPTZ)
  - relevance_score (FLOAT) -- 0-1
  - created_at
```

---

### 3. ‚ùå Market Trend Analysis

**Missing Components**:
- ‚ùå **Trend Detection**: Identify emerging trends in user's industry
- ‚ùå **Trend Tracking**: Monitor trend evolution over time
- ‚ùå **Trend Relevance**: Score trends by relevance to user
- ‚ùå **Trend Aggregation**: Aggregate trends across sources

**Required Schema**:
```sql
market_trends:
  - trend_id (UUID)
  - industry (TEXT)
  - trend_name (TEXT)
  - trend_description (TEXT)
  - trend_category (TEXT) -- technology, regulation, consumer_behavior
  - first_detected_at (TIMESTAMPTZ)
  - momentum_score (FLOAT) -- 0-1 (growing, stable, declining)
  - sources (JSONB) -- Array of source URLs
  - keywords (TEXT[])
  - created_at, updated_at

user_trend_relevance:
  - relevance_id (UUID)
  - tenant_id (UUID)
  - trend_id (UUID)
  - relevance_score (FLOAT) -- 0-1
  - reason (TEXT) -- Why this trend is relevant
  - created_at
```

---

### 4. ‚ùå Newsletter Generation Pipeline

**Missing Components**:
- ‚ùå **Personalization Engine**: Combine user profile + competitors + trends
- ‚ùå **Content Curation**: Select most relevant content for each user
- ‚ùå **Newsletter Template**: User-specific newsletter structure
- ‚ùå **A/B Testing**: Test different content strategies
- ‚ùå **Content Deduplication**: Avoid sending same content twice

**Required Logic**:
```python
class NewsletterPersonalizationEngine:
    async def generate_personalized_newsletter(
        self,
        subscription: NewsletterSubscription,
        company_snapshot: CompanySnapshot,
        competitors: List[Competitor],
        trends: List[MarketTrend],
    ) -> PersonalizedNewsletter:
        """
        Generate personalized newsletter content.
        
        Steps:
        1. Research competitor activities (last 7 days)
        2. Identify relevant market trends
        3. Aggregate industry news
        4. Curate content based on user preferences
        5. Generate newsletter sections
        6. Apply brand voice
        """
```

---

### 5. ‚ùå Scheduling & Automation

**Missing Components**:
- ‚ùå **Cron Job System**: No background job scheduler
- ‚ùå **Job Queue**: No async job processing (Celery/ARQ/RQ)
- ‚ùå **Scheduled Sends**: No weekly newsletter automation
- ‚ùå **Batch Processing**: No bulk newsletter generation
- ‚ùå **Retry Logic**: No failed send retry mechanism

**Required Infrastructure**:
```python
# Option 1: Celery + Redis
@celery.task
def generate_weekly_newsletters():
    """Run every Monday at 9 AM"""
    subscriptions = get_active_subscriptions(day="monday")
    for sub in subscriptions:
        generate_and_send_newsletter.delay(sub.subscription_id)

# Option 2: APScheduler (simpler)
scheduler = AsyncIOScheduler()
scheduler.add_job(
    generate_weekly_newsletters,
    trigger="cron",
    day_of_week="mon",
    hour=9,
    minute=0,
)
```

---

### 6. ‚ùå Analytics & Feedback Loop

**Missing Components**:
- ‚ùå **Email Analytics**: Open rates, click rates, engagement
- ‚ùå **Content Performance**: Which sections perform best
- ‚ùå **User Feedback**: Explicit feedback collection
- ‚ùå **Personalization Improvement**: ML-based optimization
- ‚ùå **Churn Prediction**: Identify users at risk of unsubscribing

**Required Schema**:
```sql
newsletter_deliveries:
  - delivery_id (UUID)
  - subscription_id (UUID)
  - newsletter_id (UUID)
  - sent_at (TIMESTAMPTZ)
  - delivery_status (TEXT) -- sent, bounced, failed
  - brevo_message_id (TEXT)
  - opened_at (TIMESTAMPTZ)
  - clicked_at (TIMESTAMPTZ)
  - unsubscribed_at (TIMESTAMPTZ)

newsletter_engagement:
  - engagement_id (UUID)
  - delivery_id (UUID)
  - event_type (TEXT) -- open, click, forward, reply
  - event_data (JSONB)
  - created_at

newsletter_feedback:
  - feedback_id (UUID)
  - delivery_id (UUID)
  - rating (INTEGER) -- 1-5
  - feedback_text (TEXT)
  - created_at
```

---

## üîÑ INTEGRATION CON SISTEMI ESISTENTI

### 1. Onboarding Flow ‚Üí Newsletter Subscription

**Current Flow**:
```
User completes onboarding ‚Üí Views Adaptive Cards ‚Üí Done
```

**New Flow**:
```
User completes onboarding ‚Üí Views Adaptive Cards ‚Üí 
  ‚Üí Opt-in to Newsletter (modal/banner) ‚Üí
  ‚Üí Configure preferences (frequency, topics) ‚Üí
  ‚Üí Create subscription record ‚Üí
  ‚Üí Send welcome email ‚Üí
  ‚Üí Schedule first newsletter
```

**Integration Points**:
- ‚úÖ Use existing `CompanySnapshot` for personalization
- ‚úÖ Use existing `user_email` for delivery
- ‚úÖ Extend `OnboardingSession` with `newsletter_opted_in` flag
- ‚úÖ Create `NewsletterSubscription` after onboarding

---

### 2. Adaptive Cards ‚Üí Newsletter Content

**Bidirectional Integration**:

**Cards ‚Üí Newsletter**:
- ‚úÖ Use Adaptive Cards as content source
- ‚úÖ Persona Cards ‚Üí Audience insights
- ‚úÖ Product Cards ‚Üí Product updates
- ‚úÖ Trend Cards ‚Üí Market trends
- ‚úÖ Competitor Cards ‚Üí Competitive intelligence

**Newsletter ‚Üí Cards**:
- ‚úÖ Newsletter content ‚Üí Create new Adaptive Cards
- ‚úÖ Competitor activities ‚Üí Update Competitor Cards
- ‚úÖ Market trends ‚Üí Create/Update Trend Cards
- ‚úÖ Performance data ‚Üí Update Card metrics

---

### 3. Publishing Systems (HubSpot/LinkedIn) ‚Üí Newsletter

**Content Repurposing**:
- ‚úÖ Newsletter content ‚Üí LinkedIn posts
- ‚úÖ Newsletter content ‚Üí HubSpot blog posts
- ‚úÖ Newsletter sections ‚Üí Social media snippets
- ‚úÖ Trend analysis ‚Üí Thought leadership content

**Cross-Channel Strategy**:
```
Weekly Newsletter (Email) ‚Üí
  ‚Üí LinkedIn Post (Monday)
  ‚Üí HubSpot Blog (Wednesday)
  ‚Üí Twitter Thread (Friday)
```

---

## üìà SUCCESS METRICS & KPIs

### Retention Metrics

| Metric | Target | Measurement |
|--------|--------|-------------|
| **Subscription Rate** | >40% of onboarded users | % users who opt-in after onboarding |
| **Open Rate** | >25% | % newsletters opened |
| **Click Rate** | >5% | % users who click links |
| **Engagement Rate** | >10% | % users who interact (open + click) |
| **Churn Rate** | <5% monthly | % users who unsubscribe |
| **Retention Lift** | +30% | Increase in 90-day retention vs non-subscribers |

### Content Quality Metrics

| Metric | Target | Measurement |
|--------|--------|-------------|
| **Relevance Score** | >4/5 | User feedback rating |
| **Content Freshness** | 100% | % content from last 7 days |
| **Personalization Accuracy** | >80% | % content relevant to user's industry |
| **Competitor Coverage** | >3 competitors/newsletter | Avg competitors mentioned |
| **Trend Coverage** | >2 trends/newsletter | Avg trends mentioned |

### Operational Metrics

| Metric | Target | Measurement |
|--------|--------|-------------|
| **Generation Time** | <5 min/newsletter | Avg time to generate |
| **Delivery Success** | >99% | % successfully delivered |
| **Cost per Newsletter** | <$0.10 | Avg cost (research + generation + delivery) |
| **Automation Rate** | 100% | % newsletters sent automatically |

---

## üéØ NEXT STEPS

1. ‚úÖ **Review this analysis** with team
2. ‚è≥ **Design complete architecture** (next document)
3. ‚è≥ **Create Linear roadmap** with tasks and estimates
4. ‚è≥ **Design database schema** for all new tables
5. ‚è≥ **Create code examples** for key components
6. ‚è≥ **Plan MVP scope** (what to build first)

---

**Status**: ‚úÖ **ANALYSIS COMPLETE**  
**Last Updated**: 2025-10-25

